/*
 * 	miaofng@2009 initial version
 */

#include "config.h"
#include "motor/math.h"
#include "normalize.h"

/*[sin(0:pi/2/128:pi/2) * (1<<15), cos(0:pi/2/128:pi/2) * (1<<15)]*/
static short hSin_Cos_Table[256] = {\
	0x0000, 0x00c9, 0x0192, 0x025b, 0x0324, 0x03ed, 0x04b6, 0x057f, \
	0x0647, 0x0710, 0x07d9, 0x08a2, 0x096a, 0x0a33, 0x0afb, 0x0bc3, \
	0x0c8b, 0x0d53, 0x0e1b, 0x0ee3, 0x0fab, 0x1072, 0x1139, 0x1201, \
	0x12c8, 0x138e, 0x1455, 0x151b, 0x15e2, 0x16a8, 0x176d, 0x1833, \
	0x18f8, 0x19bd, 0x1a82, 0x1b47, 0x1c0b, 0x1ccf, 0x1d93, 0x1e56, \
	0x1f19, 0x1fdc, 0x209f, 0x2161, 0x2223, 0x22e5, 0x23a6, 0x2467, \
	0x2528, 0x25e8, 0x26a8, 0x2767, 0x2826, 0x28e5, 0x29a3, 0x2a61, \
	0x2b1f, 0x2bdc, 0x2c98, 0x2d55, 0x2e11, 0x2ecc, 0x2f87, 0x3041, \
	0x30fb, 0x31b5, 0x326e, 0x3326, 0x33de, 0x3496, 0x354d, 0x3604, \
	0x36ba, 0x376f, 0x3824, 0x38d8, 0x398c, 0x3a40, 0x3af2, 0x3ba5, \
	0x3c56, 0x3d07, 0x3db8, 0x3e68, 0x3f17, 0x3fc5, 0x4073, 0x4121, \
	0x41ce, 0x427a, 0x4325, 0x43d0, 0x447a, 0x4524, 0x45cd, 0x4675, \
	0x471c, 0x47c3, 0x4869, 0x490f, 0x49b4, 0x4a58, 0x4afb, 0x4b9e, \
	0x4c3f, 0x4ce1, 0x4d81, 0x4e21, 0x4ebf, 0x4f5e, 0x4ffb, 0x5097, \
	0x5133, 0x51ce, 0x5269, 0x5302, 0x539b, 0x5433, 0x54ca, 0x5560, \
	0x55f5, 0x568a, 0x571d, 0x57b0, 0x5842, 0x58d4, 0x5964, 0x59f3, \
	0x5a82, 0x5b10, 0x5b9d, 0x5c29, 0x5cb4, 0x5d3e, 0x5dc7, 0x5e50, \
	0x5ed7, 0x5f5e, 0x5fe3, 0x6068, 0x60ec, 0x616f, 0x61f1, 0x6271, \
	0x62f2, 0x6371, 0x63ef, 0x646c, 0x64e8, 0x6563, 0x65dd, 0x6657, \
	0x66cf, 0x6746, 0x67bd, 0x6832, 0x68a6, 0x6919, 0x698c, 0x69fd, \
	0x6a6d, 0x6adc, 0x6b4a, 0x6bb8, 0x6c24, 0x6c8f, 0x6cf9, 0x6d62, \
	0x6dca, 0x6e30, 0x6e96, 0x6efb, 0x6f5f, 0x6fc1, 0x7023, 0x7083, \
	0x70e2, 0x7141, 0x719e, 0x71fa, 0x7255, 0x72af, 0x7307, 0x735f, \
	0x73b5, 0x740b, 0x745f, 0x74b2, 0x7504, 0x7555, 0x75a5, 0x75f4, \
	0x7641, 0x768e, 0x76d9, 0x7723, 0x776c, 0x77b4, 0x77fa, 0x7840, \
	0x7884, 0x78c7, 0x7909, 0x794a, 0x798a, 0x79c8, 0x7a05, 0x7a42, \
	0x7a7d, 0x7ab6, 0x7aef, 0x7b26, 0x7b5d, 0x7b92, 0x7bc5, 0x7bf8, \
	0x7c29, 0x7c5a, 0x7c89, 0x7cb7, 0x7ce3, 0x7d0f, 0x7d39, 0x7d62, \
	0x7d8a, 0x7db0, 0x7dd6, 0x7dfa, 0x7e1d, 0x7e3f, 0x7e5f, 0x7e7f, \
	0x7e9d, 0x7eba, 0x7ed5, 0x7ef0, 0x7f09, 0x7f21, 0x7f38, 0x7f4d, \
	0x7f62, 0x7f75, 0x7f87, 0x7f97, 0x7fa7, 0x7fb5, 0x7fc2, 0x7fce, \
	0x7fd8, 0x7fe1, 0x7fe9, 0x7ff0, 0x7ff6, 0x7ffa, 0x7ffd, 0x7fff, \
};

#define SIN_MASK 0x0300
#define U0_90		 0x0200
#define U90_180	 0x0300
#define U180_270	0x0000
#define U270_360	0x0100
void mtri(short theta, short *sin, short *cos)
{
	unsigned short hindex, sector;
	
	/* midShort = 2^15 = 2*pi/2 = pi*/
	hindex = (unsigned short)(theta + midShort);
	/*hindex:	xxx val(14bit=pi/2) */
	hindex = hindex >> 6;
	sector = hindex & SIN_MASK;
	hindex = hindex & 0xff;
	
	switch (sector) 
	{
	case U0_90:
		*sin = hSin_Cos_Table[hindex];
		*cos = hSin_Cos_Table[0xFF - hindex];
		break;
	
	case U90_180:	
		*sin = hSin_Cos_Table[0xFF - hindex];
		*cos = -hSin_Cos_Table[hindex];
		break;
	
	case U180_270:
		*sin = -hSin_Cos_Table[hindex];
		*cos = -hSin_Cos_Table[0xFF - hindex];
		break;
	
	case U270_360:
		*sin =	-hSin_Cos_Table[0xFF - hindex];
		*cos =	hSin_Cos_Table[hindex]; 
 
	default:
		break;
	}
}

static short hSigmoid_Table[512] = { \
	0x0000, 0x00a3, 0x0147, 0x01eb, 0x028f, 0x0333, 0x03d6, 0x047a, \
	0x051e, 0x05c1, 0x0665, 0x0708, 0x07ab, 0x084e, 0x08f2, 0x0995, \
	0x0a37, 0x0ada, 0x0b7d, 0x0c1f, 0x0cc1, 0x0d64, 0x0e06, 0x0ea7, \
	0x0f49, 0x0fea, 0x108c, 0x112d, 0x11cd, 0x126e, 0x130e, 0x13ae, \
	0x144e, 0x14ee, 0x158d, 0x162c, 0x16cb, 0x1769, 0x1808, 0x18a5, \
	0x1943, 0x19e0, 0x1a7d, 0x1b1a, 0x1bb6, 0x1c52, 0x1cee, 0x1d89, \
	0x1e24, 0x1ebf, 0x1f59, 0x1ff3, 0x208c, 0x2125, 0x21be, 0x2256, \
	0x22ee, 0x2385, 0x241c, 0x24b3, 0x2549, 0x25df, 0x2674, 0x2709, \
	0x279d, 0x2831, 0x28c5, 0x2958, 0x29ea, 0x2a7c, 0x2b0e, 0x2b9f, \
	0x2c2f, 0x2cc0, 0x2d4f, 0x2dde, 0x2e6d, 0x2efb, 0x2f88, 0x3015, \
	0x30a2, 0x312e, 0x31b9, 0x3244, 0x32ce, 0x3358, 0x33e1, 0x346a, \
	0x34f2, 0x3579, 0x3600, 0x3687, 0x370c, 0x3792, 0x3816, 0x389b, \
	0x391e, 0x39a1, 0x3a23, 0x3aa5, 0x3b26, 0x3ba7, 0x3c27, 0x3ca6, \
	0x3d25, 0x3da3, 0x3e20, 0x3e9d, 0x3f1a, 0x3f95, 0x4011, 0x408b, \
	0x4105, 0x417e, 0x41f7, 0x426f, 0x42e6, 0x435d, 0x43d3, 0x4449, \
	0x44be, 0x4532, 0x45a5, 0x4618, 0x468b, 0x46fd, 0x476e, 0x47de, \
	0x484e, 0x48bd, 0x492c, 0x499a, 0x4a07, 0x4a74, 0x4ae0, 0x4b4c, \
	0x4bb6, 0x4c21, 0x4c8a, 0x4cf3, 0x4d5b, 0x4dc3, 0x4e2a, 0x4e91, \
	0x4ef6, 0x4f5c, 0x4fc0, 0x5024, 0x5087, 0x50ea, 0x514c, 0x51ad, \
	0x520e, 0x526f, 0x52ce, 0x532d, 0x538b, 0x53e9, 0x5446, 0x54a3, \
	0x54ff, 0x555a, 0x55b5, 0x560f, 0x5668, 0x56c1, 0x5719, 0x5771, \
	0x57c8, 0x581f, 0x5874, 0x58ca, 0x591e, 0x5973, 0x59c6, 0x5a19, \
	0x5a6b, 0x5abd, 0x5b0e, 0x5b5f, 0x5baf, 0x5bff, 0x5c4e, 0x5c9c, \
	0x5cea, 0x5d37, 0x5d84, 0x5dd0, 0x5e1b, 0x5e66, 0x5eb1, 0x5efb, \
	0x5f44, 0x5f8d, 0x5fd5, 0x601d, 0x6064, 0x60ab, 0x60f1, 0x6136, \
	0x617b, 0x61c0, 0x6204, 0x6247, 0x628a, 0x62cd, 0x630f, 0x6350, \
	0x6391, 0x63d2, 0x6412, 0x6451, 0x6490, 0x64cf, 0x650d, 0x654a, \
	0x6587, 0x65c4, 0x6600, 0x663b, 0x6676, 0x66b1, 0x66eb, 0x6725, \
	0x675e, 0x6797, 0x67cf, 0x6807, 0x683e, 0x6875, 0x68ac, 0x68e2, \
	0x6917, 0x694d, 0x6981, 0x69b6, 0x69e9, 0x6a1d, 0x6a50, 0x6a83, \
	0x6ab5, 0x6ae6, 0x6b18, 0x6b49, 0x6b79, 0x6ba9, 0x6bd9, 0x6c08, \
	0x6c37, 0x6c66, 0x6c94, 0x6cc2, 0x6cef, 0x6d1c, 0x6d49, 0x6d75, \
	0x6da1, 0x6dcc, 0x6df7, 0x6e22, 0x6e4c, 0x6e76, 0x6ea0, 0x6ec9, \
	0x6ef2, 0x6f1b, 0x6f43, 0x6f6b, 0x6f92, 0x6fba, 0x6fe0, 0x7007, \
	0x702d, 0x7053, 0x7078, 0x709e, 0x70c3, 0x70e7, 0x710b, 0x712f, \
	0x7153, 0x7176, 0x7199, 0x71bc, 0x71de, 0x7200, 0x7222, 0x7243, \
	0x7264, 0x7285, 0x72a6, 0x72c6, 0x72e6, 0x7305, 0x7325, 0x7344, \
	0x7363, 0x7381, 0x73a0, 0x73be, 0x73db, 0x73f9, 0x7416, 0x7433, \
	0x7450, 0x746c, 0x7488, 0x74a4, 0x74c0, 0x74db, 0x74f6, 0x7511, \
	0x752c, 0x7546, 0x7561, 0x757b, 0x7594, 0x75ae, 0x75c7, 0x75e0, \
	0x75f9, 0x7611, 0x762a, 0x7642, 0x765a, 0x7671, 0x7689, 0x76a0, \
	0x76b7, 0x76ce, 0x76e4, 0x76fb, 0x7711, 0x7727, 0x773d, 0x7752, \
	0x7768, 0x777d, 0x7792, 0x77a6, 0x77bb, 0x77cf, 0x77e4, 0x77f8, \
	0x780b, 0x781f, 0x7832, 0x7846, 0x7859, 0x786c, 0x787e, 0x7891, \
	0x78a3, 0x78b6, 0x78c8, 0x78da, 0x78eb, 0x78fd, 0x790e, 0x791f, \
	0x7930, 0x7941, 0x7952, 0x7963, 0x7973, 0x7983, 0x7993, 0x79a3, \
	0x79b3, 0x79c3, 0x79d2, 0x79e2, 0x79f1, 0x7a00, 0x7a0f, 0x7a1e, \
	0x7a2c, 0x7a3b, 0x7a49, 0x7a57, 0x7a65, 0x7a73, 0x7a81, 0x7a8f, \
	0x7a9d, 0x7aaa, 0x7ab7, 0x7ac4, 0x7ad2, 0x7ade, 0x7aeb, 0x7af8, \
	0x7b04, 0x7b11, 0x7b1d, 0x7b29, 0x7b36, 0x7b42, 0x7b4d, 0x7b59, \
	0x7b65, 0x7b70, 0x7b7c, 0x7b87, 0x7b92, 0x7b9d, 0x7ba8, 0x7bb3, \
	0x7bbe, 0x7bc9, 0x7bd3, 0x7bde, 0x7be8, 0x7bf2, 0x7bfc, 0x7c06, \
	0x7c10, 0x7c1a, 0x7c24, 0x7c2e, 0x7c37, 0x7c41, 0x7c4a, 0x7c53, \
	0x7c5d, 0x7c66, 0x7c6f, 0x7c78, 0x7c81, 0x7c89, 0x7c92, 0x7c9b, \
	0x7ca3, 0x7cac, 0x7cb4, 0x7cbc, 0x7cc5, 0x7ccd, 0x7cd5, 0x7cdd, \
	0x7ce5, 0x7cec, 0x7cf4, 0x7cfc, 0x7d03, 0x7d0b, 0x7d12, 0x7d1a, \
	0x7d21, 0x7d28, 0x7d2f, 0x7d37, 0x7d3e, 0x7d45, 0x7d4b, 0x7d52, \
	0x7d59, 0x7d60, 0x7d66, 0x7d6d, 0x7d73, 0x7d7a, 0x7d80, 0x7d86, \
	0x7d8d, 0x7d93, 0x7d99, 0x7d9f, 0x7da5, 0x7dab, 0x7db1, 0x7db7, \
	0x7dbc, 0x7dc2, 0x7dc8, 0x7dcd, 0x7dd3, 0x7dd8, 0x7dde, 0x7de3, \
	0x7de9, 0x7dee, 0x7df3, 0x7df8, 0x7dfd, 0x7e02, 0x7e07, 0x7e0c, \
	0x7e11, 0x7e16, 0x7e1b, 0x7e20, 0x7e25, 0x7e29, 0x7e2e, 0x7e33, \
	0x7e37, 0x7e3c, 0x7e40, 0x7e44, 0x7e49, 0x7e4d, 0x7e52, 0x7e56, \
	0x7e5a, 0x7e5e, 0x7e62, 0x7e66, 0x7e6a, 0x7e6e, 0x7e72, 0x7e76, \
};

short msigmoid(short x)
{
	short y;
	short index;
	
	index = (x > 0)? x : -x;
	index = (index > 511)? index : 511;
	y = hSigmoid_Table[index];
	y = (x > 0)? y : -y;
	
	return y;
}

/*[0~1) -> [0~pi/4)*/
static short hAtan_table[256] = {	
	0x0000, 0x0028, 0x0051, 0x007a, 0x00a2, 0x00cb, 0x00f4, 0x011d, \
	0x0145, 0x016e, 0x0197, 0x01bf, 0x01e8, 0x0211, 0x0239, 0x0262, \
	0x028b, 0x02b3, 0x02dc, 0x0304, 0x032d, 0x0355, 0x037e, 0x03a6, \
	0x03ce, 0x03f7, 0x041f, 0x0448, 0x0470, 0x0498, 0x04c0, 0x04e8, \
	0x0511, 0x0539, 0x0561, 0x0589, 0x05b1, 0x05d9, 0x0601, 0x0628, \
	0x0650, 0x0678, 0x06a0, 0x06c7, 0x06ef, 0x0716, 0x073e, 0x0765, \
	0x078d, 0x07b4, 0x07db, 0x0803, 0x082a, 0x0851, 0x0878, 0x089f, \
	0x08c6, 0x08ed, 0x0913, 0x093a, 0x0961, 0x0987, 0x09ae, 0x09d4, \
	0x09fb, 0x0a21, 0x0a47, 0x0a6d, 0x0a94, 0x0aba, 0x0ae0, 0x0b05, \
	0x0b2b, 0x0b51, 0x0b77, 0x0b9c, 0x0bc2, 0x0be7, 0x0c0c, 0x0c32, \
	0x0c57, 0x0c7c, 0x0ca1, 0x0cc6, 0x0ceb, 0x0d0f, 0x0d34, 0x0d58, \
	0x0d7d, 0x0da1, 0x0dc6, 0x0dea, 0x0e0e, 0x0e32, 0x0e56, 0x0e7a, \
	0x0e9e, 0x0ec1, 0x0ee5, 0x0f08, 0x0f2c, 0x0f4f, 0x0f72, 0x0f95, \
	0x0fb8, 0x0fdb, 0x0ffe, 0x1021, 0x1044, 0x1066, 0x1089, 0x10ab, \
	0x10cd, 0x10ef, 0x1111, 0x1133, 0x1155, 0x1177, 0x1199, 0x11ba, \
	0x11dc, 0x11fd, 0x121e, 0x123f, 0x1260, 0x1281, 0x12a2, 0x12c3, \
	0x12e4, 0x1304, 0x1325, 0x1345, 0x1365, 0x1385, 0x13a5, 0x13c5, \
	0x13e5, 0x1405, 0x1424, 0x1444, 0x1463, 0x1483, 0x14a2, 0x14c1, \
	0x14e0, 0x14ff, 0x151e, 0x153c, 0x155b, 0x1579, 0x1598, 0x15b6, \
	0x15d4, 0x15f2, 0x1610, 0x162e, 0x164c, 0x166a, 0x1687, 0x16a5, \
	0x16c2, 0x16df, 0x16fc, 0x1719, 0x1736, 0x1753, 0x1770, 0x178c, \
	0x17a9, 0x17c5, 0x17e2, 0x17fe, 0x181a, 0x1836, 0x1852, 0x186e, \
	0x188a, 0x18a5, 0x18c1, 0x18dc, 0x18f7, 0x1913, 0x192e, 0x1949, \
	0x1964, 0x197f, 0x1999, 0x19b4, 0x19ce, 0x19e9, 0x1a03, 0x1a1d, \
	0x1a37, 0x1a51, 0x1a6b, 0x1a85, 0x1a9f, 0x1ab9, 0x1ad2, 0x1aec, \
	0x1b05, 0x1b1e, 0x1b37, 0x1b50, 0x1b69, 0x1b82, 0x1b9b, 0x1bb4, \
	0x1bcc, 0x1be5, 0x1bfd, 0x1c16, 0x1c2e, 0x1c46, 0x1c5e, 0x1c76, \
	0x1c8e, 0x1ca5, 0x1cbd, 0x1cd5, 0x1cec, 0x1d04, 0x1d1b, 0x1d32, \
	0x1d49, 0x1d60, 0x1d77, 0x1d8e, 0x1da5, 0x1dbb, 0x1dd2, 0x1de9, \
	0x1dff, 0x1e15, 0x1e2c, 0x1e42, 0x1e58, 0x1e6e, 0x1e84, 0x1e99, \
	0x1eaf, 0x1ec5, 0x1eda, 0x1ef0, 0x1f05, 0x1f1b, 0x1f30, 0x1f45, \
	0x1f5a, 0x1f6f, 0x1f84, 0x1f99, 0x1fad, 0x1fc2, 0x1fd7, 0x1feb, \
};

typedef enum {
	MATAN_SECTOR_000_090 = 0,
	MATAN_SECTOR_090_180 = 1,
	MATAN_SECTOR_180_270 = 3,
	MATAN_SECTOR_270_360 = 2
} matan_sector_t;

/*arctan(y/x), return (short) (phi/(2*pi) * (2^16)), range: -pi ~ pi */
short matan(short sin, short cos)
{
	short index, sector;
	short theta;

	sector = 0;
	if(sin < 0) {
		sin = -sin;
		sector += 2;
	}

	if(cos < 0) {
		cos = -cos;
		sector += 1;
	}

	/*range: 0~pi/2*/
	if(sin == cos){
		theta = 0x2000; /*pi/4*/
	}
	else if( sin > cos) {
		index = (cos << 8) / sin;
		theta = hAtan_table[index];
		theta = 0x4000 - theta; /*pi/2 -theta */
	} else {
		index = (sin << 8) / cos;
		theta = hAtan_table[index];
	}

	/*extend to 0~2*pi*/
	switch (sector) {
		case MATAN_SECTOR_000_090:
			break;

		case MATAN_SECTOR_090_180:
			theta = 0x4000 - theta; /*pi/2 - theta*/
			theta |= (1 << 14);
			break;

		case MATAN_SECTOR_180_270:
			theta |= (2 << 14);
			break;

		case MATAN_SECTOR_270_360:
			theta = 0x4000 - theta; /*pi/2 - theta*/
			theta |= (3 << 14);
			break;

		default:
			break;
	}

	return theta;
}

